<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text Extractor</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        select {
            padding: 8px;
            font-size: 14px;
            border-radius: 4px;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            align-self: flex-start;
        }

        button:hover {
            background-color: #0056b3;
        }

        #output {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            min-height: 100px;
            white-space: pre-wrap;
            border-radius: 4px;
            font-family: monospace;
        }

        .label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .settings-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <h1>Text Extractor</h1>

    <div class="container">
        <div>
            <label for="templateSelect" class="label">テンプレート選択:</label>
            <select id="templateSelect">
                <option value="foodSchedule">食品販売予定リスト</option>
                <option value="freeFormat">自由抽出 (要約・構造化)</option>
            </select>
        </div>

        <!-- 設定エリア (API設定) -->
        <details class="settings-container" open>
            <summary style="cursor: pointer; font-weight: bold;">設定: AI API設定</summary>
            <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 10px;">
                <p style="font-size: 0.9em; color: #666; margin-bottom: 5px;">
                    未知の店名や商品名を高精度に抽出するため、AI (LLM) を使用します。<br>
                    APIキーはブラウザ内にのみ保存され、外部サーバーには送信されません。
                </p>
                <div>
                    <label for="aiProvider" class="label">AIプロバイダー:</label>
                    <select id="aiProvider" onchange="updateUiState(); saveApiSettings()">
                        <option value="gemini">Google Gemini (推奨・無料枠あり)</option>
                        <option value="openai">OpenAI (GPT-4o/mini)</option>
                    </select>
                </div>
                <div id="apiKeyField">
                    <label for="apiKey" class="label">API Key:</label>
                    <input type="password" id="apiKey" placeholder="sk-..."
                        style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"
                        onchange="saveApiSettings()">
                    <p id="apiKeyHelp" style="font-size: 0.8em; color: #666; margin-top: 5px;">
                        <!-- JSで書き換え -->
                    </p>
                </div>
            </div>
        </details>

        <div>
            <label for="inputText" class="label">入力テキスト (自然文章):</label>
            <textarea id="inputText"
                placeholder="例: 松のやでは、12月3日（水）から『国産雪国育ち厚切りロースかつ定食』を発売します。カロリーは1135kcalです。"></textarea>
        </div>

        <button onclick="processText()">抽出・整形を実行</button>

        <div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <label for="output" class="label">出力結果:</label>
                <button id="copyButton" onclick="copyOutput()"
                    style="padding: 5px 10px; font-size: 12px; background-color: #6c757d;">コピー</button>
            </div>
            <div id="output"></div>
        </div>
    </div>

    <script>
        // API設定の読み込み
        window.addEventListener('DOMContentLoaded', () => {
            loadApiSettings();
            updateUiState();
        });

        function loadApiSettings() {
            const provider = localStorage.getItem('textExtractor_aiProvider');
            const key = localStorage.getItem('textExtractor_apiKey');
            if (provider) document.getElementById('aiProvider').value = provider;
            if (key) document.getElementById('apiKey').value = key;
        }

        function saveApiSettings() {
            const provider = document.getElementById('aiProvider').value;
            const key = document.getElementById('apiKey').value;
            localStorage.setItem('textExtractor_aiProvider', provider);
            localStorage.setItem('textExtractor_apiKey', key);
        }

        function updateUiState() {
            const provider = document.getElementById('aiProvider').value;
            const help = document.getElementById('apiKeyHelp');
            const apiKeyField = document.getElementById('apiKeyField');

            if (provider === 'gemini') {
                apiKeyField.style.display = 'block';
                help.innerHTML = 'Google Gemini APIは無料枠で利用可能です。<br><a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #007bff; text-decoration: underline;">Google AI Studio で APIキーを取得する</a>';
            } else if (provider === 'openai') {
                apiKeyField.style.display = 'block';
                help.innerHTML = 'OpenAI APIキーを入力してください（従量課金）。';
            } else {
                // chrome_builtin
                apiKeyField.style.display = 'none';
                help.innerHTML = '';
            }
        }

        // AI呼び出し関数
        async function callAI(text, systemPrompt, provider, apiKey) {
            if (provider === 'openai') {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini", // コストパフォーマンスの良いモデル
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: text }
                        ],
                        temperature: 0
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(`OpenAI API Error: ${err.error?.message || response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content.trim();

            } else if (provider === 'gemini') {
                // Gemini API (Google AI Studio)
                // 速度とコストを重視し、軽量モデル(Flash)を優先的に試行する
                const modelsToTry = [
                    "gemini-1.5-flash",      // 最速・安定・最安 (推奨)
                    "gemini-2.5-flash-lite", // 最新軽量版
                    "gemini-2.5-flash",      // 最新標準
                    "gemini-pro"             // レガシー
                ];

                let lastError;
                for (const model of modelsToTry) {
                    try {
                        // APIバージョンは v1beta を使用 (v1も存在するがbetaの方が新しいモデルへの対応が早い場合がある)
                        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                contents: [{
                                    parts: [{
                                        text: systemPrompt + "\n\n入力テキスト:\n" + text
                                    }]
                                }]
                            })
                        });

                        if (!response.ok) {
                            const err = await response.json();
                            // モデルが見つからないエラー(404)なら次のモデルを試す
                            if (response.status === 404 || (err.error && err.error.message.includes('not found'))) {
                                console.warn(`Model ${model} not found, trying next...`);
                                lastError = new Error(`Gemini API Error (${model}): ${err.error?.message}`);
                                continue;
                            }
                            throw new Error(`Gemini API Error: ${err.error?.message || response.statusText}`);
                        }

                        const data = await response.json();
                        return data.candidates[0].content.parts[0].text.trim();

                    } catch (e) {
                        lastError = e;
                        // ネットワークエラーや認証エラーなど、モデル起因でない場合はループを抜けてエラーにする
                        if (!e.message.includes('not found') && !e.message.includes('404')) {
                            throw e;
                        }
                    }
                }
                throw lastError;
            }

            throw new Error("Unknown provider");
        }

        // テンプレート定義
        const templates = {
            foodSchedule: {
                name: "食品販売予定リスト",
                process: async (text) => {
                    const provider = document.getElementById('aiProvider').value;
                    const apiKey = document.getElementById('apiKey').value;

                    if (provider !== 'chrome_builtin' && !apiKey) {
                        throw new Error("APIキーが設定されていません。設定エリアに入力してください。");
                    }

                    const now = new Date();
                    const currentYear = now.getFullYear();
                    const systemPrompt = `
あなたはテキストから食品の販売情報を抽出するアシスタントです。
現在の日時は ${currentYear}年${now.getMonth() + 1}月${now.getDate()}日 です。
入力されたテキストから、以下の情報を抽出し、指定されたフォーマットで出力してください。

フォーマット:
MM/DD(曜)「商品名」(店名) カロリー

ルール:
1. 日付、曜日、商品名、店名、カロリーを抽出すること。
2. 日付は MM/DD 形式。曜日は (月)〜(日) の形式とし、入力に記載がない場合は ${currentYear}年 (または文脈に応じた適切な年) の日付として正しい曜日を計算して補完すること。
3. 商品名は「」で囲むこと。
4. 店名は文脈から判断し、()で囲むこと。
5. カロリーは "123kcal" の形式にすること。不明な場合は省略可。
6. 複数の商品がある場合は改行区切りで出力すること。
7. 余計な挨拶や説明は一切不要。抽出結果のみを出力すること。
8. 抽出対象がない場合は "抽出対象が見つかりませんでした。" と出力すること。
`;
                    return await callAI(text, systemPrompt, provider, apiKey);
                }
            },
            freeFormat: {
                name: "自由抽出 (要約・構造化)",
                process: async (text) => {
                    const provider = document.getElementById('aiProvider').value;
                    const apiKey = document.getElementById('apiKey').value;

                    if (provider !== 'chrome_builtin' && !apiKey) {
                        throw new Error("APIキーが設定されていません。設定エリアに入力してください。");
                    }

                    const systemPrompt = `
あなたは優秀なテキスト処理アシスタントです。
入力されたテキストから重要な情報を抽出し、見やすく整理して出力してください。
箇条書きやMarkdown形式を活用してください。
`;
                    return await callAI(text, systemPrompt, provider, apiKey);
                }
            }
        };

        async function processText() {
            const input = document.getElementById('inputText').value;
            const templateKey = document.getElementById('templateSelect').value;
            const outputDiv = document.getElementById('output');

            if (!input) {
                outputDiv.textContent = "テキストを入力してください。";
                return;
            }

            const template = templates[templateKey];
            if (template) {
                try {
                    outputDiv.textContent = "AI処理中...";
                    const result = await template.process(input);
                    outputDiv.textContent = result;
                } catch (e) {
                    outputDiv.textContent = "エラーが発生しました: " + e.message;
                    console.error(e);
                }
            } else {
                outputDiv.textContent = "テンプレートが見つかりません。";
            }
        }

        function copyOutput() {
            const outputText = document.getElementById('output').textContent;
            const copyButton = document.getElementById('copyButton');

            if (!outputText) {
                return;
            }
            navigator.clipboard.writeText(outputText).then(() => {
                const originalText = copyButton.textContent;
                copyButton.textContent = "コピーしました！";
                copyButton.style.backgroundColor = "#28a745"; // 緑色に変更

                setTimeout(() => {
                    copyButton.textContent = originalText;
                    copyButton.style.backgroundColor = "#6c757d"; // 元の色に戻す
                }, 2000);
            }).catch(err => {
                console.error('コピーに失敗しました:', err);
            });
        }
    </script>
</body>

</html>